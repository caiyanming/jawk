package org.metricshub.jawk;

import static org.junit.Assert.*;

import java.util.Locale;
import org.junit.Assume;
import org.junit.Test;
import org.metricshub.jawk.intermediate.UninitializedObject;
import org.metricshub.jawk.jrt.AssocArray;
import org.metricshub.jawk.jrt.JRT;

public class JRTTest {

	private static final boolean IS_WINDOWS = System.getProperty("os.name").contains("Windows");

	@Test
	public void testToDouble() {
		assertEquals(65.0, JRT.toDouble('A'), 0);
		assertEquals(65.0, JRT.toDouble(65), 0);
		assertEquals(65.0, JRT.toDouble(65L), 0);
		assertEquals(65.0, JRT.toDouble(65.0), 0);
		assertEquals(65.1, JRT.toDouble(65.1), 0);
		assertEquals(65.9, JRT.toDouble(65.9), 0);
		assertEquals(65.0, JRT.toDouble(Integer.valueOf(65)), 0);
		assertEquals(65.0, JRT.toDouble(Long.valueOf(65)), 0);
		assertEquals(65.0, JRT.toDouble(Float.valueOf(65)), 0);
		assertEquals(65.0, JRT.toDouble(Double.valueOf(65)), 0);
		assertEquals(65.0, JRT.toDouble("65"), 0);
		assertEquals(65.0, JRT.toDouble("65A"), 0);
		assertEquals(65.0, JRT.toDouble("65A6666666666666666666666666600000000033333333333999999999999"), 0);
		assertEquals(65.0, JRT.toDouble("6.5E+1"), 0);
		assertEquals(0.0, JRT.toDouble(""), 0);
		Object nothing = null;
		assertEquals(0.0, JRT.toDouble(nothing), 0);
	}

	@Test
	public void testToLong() {
		assertEquals(65L, JRT.toLong('A'));
		assertEquals(65L, JRT.toLong(65));
		assertEquals(65L, JRT.toLong(65L));
		assertEquals(65L, JRT.toLong(65.0));
		assertEquals(65L, JRT.toLong(65.1));
		assertEquals(65L, JRT.toLong(65.9));
		assertEquals(65L, JRT.toLong(Integer.valueOf(65)));
		assertEquals(65L, JRT.toLong(Long.valueOf(65)));
		assertEquals(65L, JRT.toLong(Float.valueOf(65)));
		assertEquals(65L, JRT.toLong(Double.valueOf(65)));
		assertEquals(65L, JRT.toLong("65"));
		assertEquals(65L, JRT.toLong("65A"));
		assertEquals(65L, JRT.toLong("65A6666666666666666666666666600000000033333333333999999999999"));
		assertEquals(0L, JRT.toLong(""));
		Object nothing = null;
		assertEquals(0L, JRT.toLong(nothing));
	}

	@Test
	public void testCompare2Uninitialized() {
		// Uninitialized ==
		assertTrue(JRT.compare2(new UninitializedObject(), new UninitializedObject(), 0));
		assertTrue(JRT.compare2(new UninitializedObject(), "0", 0));
		assertTrue(JRT.compare2(new UninitializedObject(), 0, 0));
		assertTrue(JRT.compare2("0", new UninitializedObject(), 0));
		assertTrue(JRT.compare2(0, new UninitializedObject(), 0));
		assertFalse(JRT.compare2(new UninitializedObject(), "1", 0));
		assertFalse(JRT.compare2(new UninitializedObject(), 1, 0));
		assertFalse(JRT.compare2("1", new UninitializedObject(), 0));
		assertFalse(JRT.compare2(1, new UninitializedObject(), 0));

		// Uninitialized <
		assertFalse(JRT.compare2(new UninitializedObject(), new UninitializedObject(), -1));
		assertFalse(JRT.compare2(new UninitializedObject(), "0", -1));
		assertFalse(JRT.compare2(new UninitializedObject(), 0, -1));
		assertFalse(JRT.compare2("0", new UninitializedObject(), -1));
		assertFalse(JRT.compare2(0, new UninitializedObject(), -1));
		assertTrue(JRT.compare2(new UninitializedObject(), "1", -1));
		assertTrue(JRT.compare2(new UninitializedObject(), 1, -1));
		assertFalse(JRT.compare2("1", new UninitializedObject(), -1));
		assertFalse(JRT.compare2(1, new UninitializedObject(), -1));

		// Uninitialized >
		assertFalse(JRT.compare2(new UninitializedObject(), new UninitializedObject(), 1));
		assertFalse(JRT.compare2(new UninitializedObject(), "0", 1));
		assertFalse(JRT.compare2(new UninitializedObject(), 0, 1));
		assertFalse(JRT.compare2("0", new UninitializedObject(), 1));
		assertFalse(JRT.compare2(0, new UninitializedObject(), 1));
		assertFalse(JRT.compare2(new UninitializedObject(), "1", 1));
		assertFalse(JRT.compare2(new UninitializedObject(), 1, 1));
		assertTrue(JRT.compare2("1", new UninitializedObject(), 1));
		assertTrue(JRT.compare2(1, new UninitializedObject(), 1));
	}

	@Test
	public void testPrepareReplacement() throws Exception {
		assertEquals("don't change", JRT.prepareReplacement("don't change"));
		assertEquals("a$0a", JRT.prepareReplacement("a&a"));
		assertEquals("1$01", JRT.prepareReplacement("1&1"));
		assertEquals("a$0b$0c", JRT.prepareReplacement("a&b&c"));
		assertEquals("a\\b", JRT.prepareReplacement("a\\b"));
		assertEquals("a&b", JRT.prepareReplacement("a\\&b"));
		assertEquals("a\\", JRT.prepareReplacement("a\\"));
		assertEquals("a\\$", JRT.prepareReplacement("a$"));
		assertEquals("a\\\\$", JRT.prepareReplacement("a\\$"));
		assertEquals("a\\\\\\$", JRT.prepareReplacement("a\\\\$"));
		assertEquals("a\\\\$0", JRT.prepareReplacement("a\\\\&"));
		assertEquals("a\\\\&", JRT.prepareReplacement("a\\\\\\&"));
		assertEquals("", JRT.prepareReplacement(""));
		assertEquals("", JRT.prepareReplacement(null));
	}

	@Test
	public void testSpawnProcessCat() throws Exception {
		Assume.assumeFalse(IS_WINDOWS);
		AwkTestSupport
				.awkTest("cat process")
				.script("BEGIN { print \"Hello\" | \"cat\"; close(\"cat\") }")
				.expectLines("Hello")
				.runAndAssert();
	}

	@Test
	public void testSpawnProcessMore() throws Exception {
		Assume.assumeTrue(IS_WINDOWS);
		AwkTestSupport
				.awkTest("more process")
				.script("BEGIN { print \"Hello\" | \"more\"; close(\"more\") }")
				.expect("Hello\n\n")
				.runAndAssert();
	}

	@Test
	public void testSystemPipe() throws Exception {
		Assume.assumeFalse(IS_WINDOWS);
		AwkTestSupport
				.awkTest("system pipe")
				.script("BEGIN { print(system(\"echo test | grep test\")) }")
				.expectLines("test", "0")
				.runAndAssert();
	}

	@Test
	public void testSystemPipeWindows() throws Exception {
		Assume.assumeTrue(IS_WINDOWS);
		AwkTestSupport
				.awkTest("system pipe windows")
				.script("BEGIN { print(system(\"echo test|findstr test\")) }")
				.expect("test\n0\n")
				.runAndAssert();
	}

	@Test
	public void testPrintfSpecialCharacters() throws Exception {
		AwkTestSupport
				.awkTest("printf special characters")
				.script("BEGIN { printf \"%c\\n\", 17379 }")
				.expectLines("\u43e3")
				.runAndAssert();
	}

	@Test
	public void testSplitSetsFieldZero() {
		AssocArray aa = new AssocArray(false);
		int n = JRT.split(aa, "a b", "%.6g", Locale.US);
		assertEquals(2, n);
		assertEquals(2, aa.get(0));
	}

	@Test
	public void testSplitRegexWhitespace() {
		AssocArray aa = new AssocArray(false);
		int n = JRT.split("[ \t]+", aa, " 9853   shen", "%.6g", Locale.US);
		assertEquals(3, n);
		assertEquals("", aa.get(1));
		assertEquals("9853", aa.get(2));
		assertEquals("shen", aa.get(3));
	}

	@Test
	public void testRegexFsKeepsLeadingAndTrailingSeparators() throws Exception {
		AwkTestSupport
				.awkTest("regex fs retains separators")
				.script("BEGIN { FS = \"[ \\t\\n]+\" } { print $2 }")
				.stdin("  a  b  c  d ")
				.expectLines("a")
				.runAndAssert();
	}
}
